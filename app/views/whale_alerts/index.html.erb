<!-- app/views/whale_alerts/index.html.erb -->
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="flex items-center justify-between gap-4 mb-6">
    <h1 class="text-2xl font-bold text-gray-100">Whale Alerts</h1>

    <div class="text-sm text-gray-400">
      Seuil: <span class="font-mono"><%= ENV.fetch("WHALE_MIN_BTC", "100") %> BTC</span>
    </div>

    <div class="flex flex-wrap items-center gap-3">
      <%= link_to "‚¨ÖÔ∏è Retour au dashboard",
                  dashboard_path,
                  class: "inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-900/70 border border-gray-700 text-gray-100 text-sm hover:bg-gray-700 transition" %>
    </div>
  </div>

  <%# -------------------- Filters -------------------- %>
  <form method="get" class="bg-gray-900/40 border border-gray-800 rounded-2xl p-4 mb-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-8 gap-3">
      <select name="mode" class="w-full bg-gray-950 border border-gray-800 rounded-xl px-3 py-2 text-gray-100">
        <option value="interesting" <%= "selected" if @mode == "interesting" %>>Interesting</option>
        <option value="all" <%= "selected" if @mode == "all" %>>Tout</option>
      </select>

      <select name="type" class="w-full bg-gray-950 border border-gray-800 rounded-xl px-3 py-2 text-gray-100">
        <option value="">Tous les types</option>
        <% types =
          if @mode == "interesting"
            WhaleAlert::TYPES - ["other"]
          else
            WhaleAlert::TYPES
          end
        %>
        <% types.each do |t| %>
          <option value="<%= t %>" <%= "selected" if @type == t %>><%= t %></option>
        <% end %>
      </select>

      <input name="min_btc" value="<%= @min_btc %>" placeholder="min BTC (ex: 200)"
             class="w-full bg-gray-950 border border-gray-800 rounded-xl px-3 py-2 text-gray-100" />

      <select name="sort" class="w-full bg-gray-950 border border-gray-800 rounded-xl px-3 py-2 text-gray-100">
        <option value="recent" <%= "selected" if @sort == "recent" %>>Plus r√©cent</option>
        <option value="score" <%= "selected" if @sort == "score" %>>Score (desc)</option>
      </select>

      <input name="min_score" value="<%= @min_score %>" placeholder="score min (ex: 70)"
             class="w-full bg-gray-950 border border-gray-800 rounded-xl px-3 py-2 text-gray-100" />

      <input name="min_exchange" value="<%= @min_exchange %>" placeholder="exchange min (ex: 70)"
             class="w-full bg-gray-950 border border-gray-800 rounded-xl px-3 py-2 text-gray-100" />

      <button type="submit"
              class="w-full bg-white/10 hover:bg-white/15 border border-gray-700 rounded-xl px-4 py-2 text-gray-100">
        Filtrer
      </button>

      <a href="<%= whale_alerts_path %>"
         class="w-full text-center bg-gray-950 hover:bg-gray-900 border border-gray-800 rounded-xl px-4 py-2 text-gray-300">
        Reset
      </a>
    </div>

    <% if @counts.present? %>
      <div class="mt-3 flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-400">
        <% @counts.each do |k, v| %>
          <span><span class="font-mono text-gray-200"><%= v %></span> <%= k %></span>
        <% end %>
      </div>
    <% end %>
  </form>

  <%# -------------------- Chart 1: Volume BTC (14 jours) -------------------- %>
  <% points = @volume_points || [] %>
  <% w = 900.0; h = 220.0; pad_x = 24.0; pad_y = 18.0 %>

  <% max_btc = points.map { |p| p[:btc].to_d }.max || 0.to_d %>
  <% min_btc = points.map { |p| p[:btc].to_d }.min || 0.to_d %>
  <% span = (max_btc - min_btc) %>
  <% span = 1.to_d if span.zero? %>

  <% n = points.size %>
  <% step = n > 1 ? ((w - 2 * pad_x) / (n - 1)) : 0 %>

  <% coords = points.each_with_index.map do |p, i|
    x = pad_x + step * i
    y = pad_y + (h - 2 * pad_y) * (1.0 - ((p[:btc].to_d - min_btc) / span).to_f)
    { x: x, y: y, p: p }
  end %>

  <% path_d = coords.map.with_index do |c, i|
    cmd = (i == 0 ? "M" : "L")
    "#{cmd} #{c[:x].round(2)} #{c[:y].round(2)}"
  end.join(" ") %>

  <section class="mt-6 bg-gray-900/40 border border-gray-800 rounded-2xl p-4 sm:p-6">
    <div class="flex items-center justify-between gap-3 mb-3">
      <h2 class="text-base font-semibold text-gray-100">Volume BTC (14 jours)</h2>
      <div class="text-xs text-gray-500 font-mono">
        min <%= format("%.2f", min_btc.to_f) %> ¬∑ max <%= format("%.2f", max_btc.to_f) %>
      </div>
    </div>

    <div class="relative">
      <svg viewBox="0 0 <%= w.to_i %> <%= h.to_i %>" class="w-full h-56">
        <line x1="<%= pad_x %>" y1="<%= h - pad_y %>" x2="<%= w - pad_x %>" y2="<%= h - pad_y %>"
              class="stroke-gray-800" stroke-width="1" />

        <path d="<%= path_d %>" fill="none" class="stroke-gray-200" stroke-width="2" />

        <% coords.each do |c| %>
          <% day = c[:p][:day] %>
          <% btc = c[:p][:btc].to_d %>
          <% eur = c[:p][:eur] %>
          <% dlt = c[:p][:delta_pct] %>

          <circle
            cx="<%= c[:x].round(2) %>" cy="<%= c[:y].round(2) %>" r="4"
            class="fill-gray-200 hover:fill-white cursor-pointer"
            data-tooltip="1"
            data-day="<%= day.strftime("%Y-%m-%d") %>"
            data-btc="<%= format("%.2f", btc.to_f) %>"
            data-eur="<%= eur ? eur_human(eur) : "" %>"
            data-delta="<%= dlt ? format("%.1f", dlt.to_f) : "" %>"
          />
        <% end %>
      </svg>

      <div id="whale-volume-tooltip"
           class="pointer-events-none absolute hidden z-10
                  bg-gray-950/95 border border-gray-800 rounded-xl px-3 py-2
                  text-xs text-gray-100 shadow-xl">
        <div class="font-mono text-gray-300" data-t="day"></div>
        <div class="mt-1">
          <span class="text-gray-400">Volume:</span>
          <span class="font-mono text-gray-100" data-t="btc"></span>
          <span class="text-gray-500" data-t="eur"></span>
        </div>
        <div class="mt-1">
          <span class="text-gray-400">vs veille:</span>
          <span class="font-mono" data-t="delta"></span>
        </div>
      </div>
    </div>

    <div class="mt-2 text-xs text-gray-500">
      Survoler un point pour voir le volume du jour et la variation vs la veille.
    </div>
  </section>

  <%# -------------------- Chart 2: Activit√© par type (stacked counts) -------------------- %>
  <% type_color = {
    "consolidation" => "bg-violet-400/90",
    "distribution"  => "bg-emerald-400/90",
    "batching"      => "bg-sky-400/90",
    "other"         => "bg-gray-400/70"
  } %>

  <section class="mt-6 bg-gray-900/40 border border-gray-800 rounded-2xl p-4 sm:p-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
      <div>
        <h2 class="text-base font-semibold text-gray-100">Activit√© par type (counts / jour)</h2>
        <div class="text-xs text-gray-500">14 jours ¬∑ barres empil√©es ¬∑ survol pour d√©tails</div>
      </div>

      <div class="flex flex-wrap gap-3 text-xs text-gray-400">
        <% WhaleAlert::TYPES.each do |t| %>
          <span class="inline-flex items-center gap-2">
            <span class="inline-block w-2 h-2 rounded-full <%= type_color[t] %>"></span>
            <%= t %>
          </span>
        <% end %>
      </div>
    </div>

    <div class="relative" id="whale-stacked-chart">
      <div class="space-y-2">
        <% (@chart_counts || []).each do |row| %>
          <% total = row[:total].to_i %>
          <% day   = row[:day] %>

          <div class="grid grid-cols-12 gap-3 items-center">
            <div class="col-span-3 sm:col-span-2 text-xs text-gray-500 font-mono">
              <%= day.strftime("%m-%d") %>
            </div>

            <div class="col-span-7 sm:col-span-8">
              <div
                class="w-full h-3 rounded-full bg-gray-950/70 border border-gray-800 overflow-hidden flex"
                data-stack="1"
                data-day="<%= day.strftime("%Y-%m-%d") %>"
                data-total="<%= total %>"
                data-delta="<%= row[:delta_pct] ? format("%.1f", row[:delta_pct]) : "" %>"
                data-consolidation="<%= row[:by_type]["consolidation"].to_i %>"
                data-distribution="<%= row[:by_type]["distribution"].to_i %>"
                data-batching="<%= row[:by_type]["batching"].to_i %>"
                data-other="<%= row[:by_type]["other"].to_i %>"
              >
                <% WhaleAlert::TYPES.each do |t| %>
                  <% v = row[:by_type][t].to_i %>
                  <% next if v <= 0 || total <= 0 %>
                  <div class="<%= type_color[t] %>" style="width:<%= (v * 100.0 / total).round(2) %>%"></div>
                <% end %>
              </div>
            </div>

            <div class="col-span-2 text-xs text-gray-400 font-mono text-right">
              <%= total %>
            </div>
          </div>
        <% end %>
      </div>

      <div id="whale-stacked-tooltip"
           class="pointer-events-none absolute hidden z-10
                  bg-gray-950/95 border border-gray-800 rounded-xl px-3 py-2
                  text-xs text-gray-100 shadow-xl">
        <div class="font-mono text-gray-300" data-s="day"></div>

        <div class="mt-1">
          <span class="text-gray-400">total:</span>
          <span class="font-mono text-gray-100" data-s="total"></span>
          <span class="font-mono" data-s="delta"></span>
        </div>

        <div class="mt-2 space-y-1">
          <% WhaleAlert::TYPES.each do |t| %>
            <div class="flex items-center justify-between gap-4">
              <span class="inline-flex items-center gap-2 text-gray-300">
                <span class="inline-block w-2 h-2 rounded-full <%= type_color[t] %>"></span>
                <%= t %>
              </span>
              <span class="font-mono text-gray-100" data-s="<%= t %>"></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="mt-2 text-xs text-gray-500">
      Le total correspond au nombre d‚Äôalertes (transactions) d√©tect√©es ce jour-l√†.
    </div>
  </section>

  <%# -------------------- JS (tooltips) -------------------- %>
  <script>
    (function() {
      const tip = document.getElementById("whale-volume-tooltip");
      if (!tip) return;

      const setText = (sel, txt) => {
        const el = tip.querySelector(`[data-t="${sel}"]`);
        if (el) el.textContent = txt || "";
      };

      const fmtDelta = (d) => {
        if (!d) return "‚Äî";
        const v = parseFloat(d);
        if (Number.isNaN(v)) return "‚Äî";
        const arrow = v >= 0 ? "‚ñ≤" : "‚ñº";
        return `${arrow} ${v >= 0 ? "+" : ""}${v.toFixed(1)}%`;
      };

      document.querySelectorAll('circle[data-tooltip="1"]').forEach((pt) => {
        pt.addEventListener("mouseenter", () => {
          setText("day", pt.dataset.day);
          setText("btc", pt.dataset.btc ? `${pt.dataset.btc} BTC` : "");
          setText("eur", pt.dataset.eur ? ` ¬∑ ${pt.dataset.eur}` : "");

          const deltaEl = tip.querySelector('[data-t="delta"]');
          if (deltaEl) {
            const delta = fmtDelta(pt.dataset.delta);
            deltaEl.textContent = delta;
            deltaEl.className =
              "font-mono " +
              (pt.dataset.delta && parseFloat(pt.dataset.delta) >= 0 ? "text-emerald-300" : "text-rose-300");
          }

          tip.classList.remove("hidden");
        });

        pt.addEventListener("mousemove", (e) => {
          const container = tip.closest(".relative");
          const r = container.getBoundingClientRect();

          const mouseX = e.clientX - r.left;
          const mouseY = e.clientY - r.top;

          const tipWidth  = tip.offsetWidth;
          const tipHeight = tip.offsetHeight;
          const padding = 12;

          let x = mouseX + padding;
          let y = mouseY + padding;

          if (x + tipWidth > r.width) x = mouseX - tipWidth - padding;
          if (y + tipHeight > r.height) y = mouseY - tipHeight - padding;

          x = Math.max(padding, Math.min(x, r.width  - tipWidth  - padding));
          y = Math.max(padding, Math.min(y, r.height - tipHeight - padding));

          tip.style.left = x + "px";
          tip.style.top  = y + "px";
        });

        pt.addEventListener("mouseleave", () => tip.classList.add("hidden"));
      });
    })();
  </script>

  <script>
    (function() {
      const chart = document.getElementById("whale-stacked-chart");
      const tip   = document.getElementById("whale-stacked-tooltip");
      if (!chart || !tip) return;

      const setText = (sel, txt) => {
        const el = tip.querySelector(`[data-s="${sel}"]`);
        if (el) el.textContent = txt || "";
      };

      const fmtDelta = (d) => {
        if (!d) return "";
        const v = parseFloat(d);
        if (Number.isNaN(v)) return "";
        const arrow = v >= 0 ? "‚ñ≤" : "‚ñº";
        return ` ${arrow} ${v >= 0 ? "+" : ""}${v.toFixed(1)}%`;
      };

      chart.querySelectorAll('[data-stack="1"]').forEach((bar) => {
        bar.addEventListener("mouseenter", () => {
          setText("day", bar.dataset.day);
          setText("total", bar.dataset.total);

          const deltaEl = tip.querySelector('[data-s="delta"]');
          if (deltaEl) {
            const delta = fmtDelta(bar.dataset.delta);
            deltaEl.textContent = delta || "";
            deltaEl.className =
              "font-mono " +
              (bar.dataset.delta && parseFloat(bar.dataset.delta) >= 0 ? "text-emerald-300" : "text-rose-300");
          }

          ["consolidation","distribution","batching","other"].forEach((t) => setText(t, bar.dataset[t] || "0"));
          tip.classList.remove("hidden");
        });

        bar.addEventListener("mousemove", (e) => {
          const r = chart.getBoundingClientRect();
          const mouseX = e.clientX - r.left;
          const mouseY = e.clientY - r.top;

          const tipWidth  = tip.offsetWidth;
          const tipHeight = tip.offsetHeight;
          const padding = 12;

          let x = mouseX + padding;
          let y = mouseY + padding;

          if (x + tipWidth > r.width) x = mouseX - tipWidth - padding;
          if (y + tipHeight > r.height) y = mouseY - tipHeight - padding;

          x = Math.max(padding, Math.min(x, r.width  - tipWidth  - padding));
          y = Math.max(padding, Math.min(y, r.height - tipHeight - padding));

          tip.style.left = x + "px";
          tip.style.top  = y + "px";
        });

        bar.addEventListener("mouseleave", () => tip.classList.add("hidden"));
      });
    })();
  </script>

  <%# -------------------- Explain block (collapsible) -------------------- %>
  <details class="mt-4 bg-gray-900/40 border border-gray-800 rounded-2xl">
    <summary class="cursor-pointer select-none p-4 flex items-center justify-between gap-3 text-sm text-gray-200">
      <span class="font-semibold">üìò Comment lire les Whale Alerts</span>
      <span class="text-gray-500 text-xs">Afficher / masquer</span>
    </summary>

    <div class="px-4 pb-4 prose prose-invert max-w-none text-sm">
      <%= raw MarkdownRenderer.to_html(<<~MD) %>
### √Ä quoi servent les Whale Alerts

Les Whale Alerts permettent d‚Äôobserver **le comportement des gros portefeuilles**  
Elles ne pr√©disent pas le prix  
Elles montrent **ce que font les acteurs importants sur la blockchain**

---

### Les diff√©rents comportements observ√©s

**Consolidation**  
Des fonds dispers√©s sont regroup√©s en une ou deux sorties  
Indique souvent une phase de pr√©paration ou de r√©organisation  
Ce n‚Äôest pas une vente

**Distribution**  
Un montant important est r√©parti vers de nombreuses sorties  
Correspond √† une phase d‚Äôex√©cution ou de dispersion  
Peut inclure paiements ou ventes fractionn√©es

**Batching**  
Un grand nombre de sorties dans une seule transaction  
Comportement typique de services ou plateformes  
Signal d‚Äôactivit√© op√©rationnelle, pas de sentiment de march√©

**Other**  
Transaction importante sans comportement identifiable  
Repr√©sente le bruit normal de la blockchain  
La majorit√© des transactions entrent dans cette cat√©gorie

---

### Indicateur *Exchange-like*

L‚Äôindicateur **Exchange-like** indique si une transaction  
**ressemble au comportement d‚Äôun service** (exchange, plateforme, paiement)

Il ne dit **pas** qui est derri√®re la transaction  
Il ne signifie **pas** achat ou vente

Il se base sur des signaux simples :
- beaucoup de sorties
- r√©partition en plusieurs paiements
- absence de sortie dominante
- patterns fr√©quents chez les services

**Lecture du score :**
- **85 ‚Äì 100** : quasi certain (services / exchanges)
- **70 ‚Äì 84** : comportement tr√®s compatible
- **45 ‚Äì 69** : ambigu 
- **0 ‚Äì 44** : peu probable

Un score √©lev√© indique une **activit√© op√©rationnelle**, pas une intention de march√©.

---

### Modes d‚Äôaffichage

**Interesting**  
Affiche uniquement les comportements intentionnels  
Consolidation Distribution Batching  
Permet de se concentrer sur ce qui m√©rite une attention particuli√®re

**Tout**  
Affiche toutes les transactions importantes  
Inclut aussi **Other** pour une vision compl√®te

---

### Lexique des m√©triques

**inputs**  
Nombre d‚Äôentr√©es de la transaction

**outputs**  
Nombre de sorties de la transaction

**nonzero**  
Nombre de sorties dont la valeur est strictement sup√©rieure √† 0 BTC

**largest**  
La plus grosse sortie en BTC

**ratio**  
largest √∑ total_out  
Proche de 100% ‚Üí une sortie domine la transaction

**score**  
Note simple de 0 √† 100 pour trier les alertes  
Le score ne pr√©dit pas le prix

      MD
    </div>
  </details>

  <%# -------------------- List -------------------- %>
  <div class="mt-4 space-y-3">
    <% @alerts.each do |a| %>
      <% meta = (a.meta.is_a?(Hash) ? a.meta.with_indifferent_access : {}) %>
      <% ex = a.exchange_likelihood %>
      <% hint = a.exchange_hint.to_s %>
      <% reasons = meta[:exchange_reasons] %>

      <div class="bg-gray-900/40 border border-gray-800 rounded-2xl p-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-xs px-2 py-1 rounded-full border border-gray-700 text-gray-200">
              <%= a.alert_type %>
            </span>

            <span class="text-xs px-2 py-1 rounded-full bg-white/10 text-gray-200">
              score <%= a.score %>
            </span>

            <% if ex.present? %>
              <% ex_i = ex.to_i %>
              <% css =
                  case hint.to_s
                  when "very-likely"
                    "text-red-300 bg-red-500/10"
                  when "exchange-like"
                    "text-rose-300 bg-rose-500/10"
                  when "possible"
                    "text-amber-300 bg-amber-500/10"
                  when "unlikely"
                    "text-gray-300 bg-white/5"
                  else
                    # fallback si hint manquant
                    ex_i >= 85 ? "text-red-300 bg-red-500/10" :
                      (ex_i >= 70 ? "text-rose-300 bg-rose-500/10" :
                        (ex_i >= 45 ? "text-amber-300 bg-amber-500/10" : "text-gray-300 bg-white/5"))
                  end
              %>

              <span class="text-xs px-2 py-1 rounded-full border border-gray-700 <%= css %>">
                EX <span class="font-mono"><%= ex_i %></span>
                <% if hint.present? %><span class="text-gray-400 ml-1"><%= hint %></span><% end %>
              </span>
            <% else %>
              <span class="text-xs px-2 py-1 rounded-full border border-gray-800 text-gray-500 bg-white/5">
                EX <span class="font-mono">‚Äî</span>
                <span class="text-gray-600 ml-1">N/A</span>
              </span>
            <% end %>

            <span class="text-sm text-gray-400">
              <%= a.block_time ? a.block_time.strftime("%Y-%m-%d %H:%M:%S UTC") : "mempool" %>
            </span>
          </div>

          <div class="text-sm text-gray-300 font-mono">
            <%= btc(a.total_out_btc) %>
            <% if @btc_eur %>
              <span class="text-gray-500">
                ¬∑ <%= eur_human(a.total_out_btc.to_d * @btc_eur) %>
              </span>
            <% end %>
          </div>
        </div>

        <% if reasons.present? %>
          <div class="mt-2 text-xs text-gray-500">
            
            <span class="font-mono"><%= Array(reasons).join(" ¬∑ ") %></span>
          </div>
        <% end %>

        <div class="mt-2 text-sm text-gray-400">
          inputs: <span class="font-mono text-gray-200"><%= a.inputs_count %></span>
          ¬∑ outputs: <span class="font-mono text-gray-200"><%= a.outputs_count %></span>
          ¬∑ nonzero: <span class="font-mono text-gray-200"><%= a.outputs_nonzero_count %></span>
          ¬∑ largest: <span class="font-mono text-gray-200"><%= btc(a.largest_output_btc) %></span>
          ¬∑ ratio: <span class="font-mono text-gray-200"><%= (a.largest_output_ratio.to_d * 100).round(2) %>%</span>
        </div>

        <div class="mt-2 text-xs text-gray-500 font-mono break-all">
          <%= a.txid %>
        </div>
      </div>
    <% end %>
  </div>
</div>
