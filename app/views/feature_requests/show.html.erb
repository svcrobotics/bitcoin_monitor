<div class="px-4 py-8 sm:px-6 lg:px-8">
  <div class="mx-auto w-full max-w-5xl">

    <!-- HEADER -->
    <header class="mb-8">
      <h1 class="text-3xl sm:text-4xl font-bold tracking-tight mb-2">
        Demande d'amélioration
      </h1>

      <p class="text-sm text-gray-400">
        Sponsorise des évolutions de <span class="font-semibold">Bitcoin Monitor</span> en sats ⚡
      </p>

      <div class="mt-4 flex flex-wrap items-center gap-3">
        <%= link_to "← Retour aux idées & améliorations",
                    feature_requests_path,
                    class: "inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-900/70 border border-gray-700 text-gray-200 text-sm hover:bg-gray-800 hover:border-gray-500 transition" %>
      </div>
    </header>

    <!-- CARTE PRINCIPALE : INFOS DEMANDE -->
    <section class="mt-6 bg-gray-800/80 border border-gray-700 rounded-2xl p-6 sm:p-8 shadow-xl">
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-4">
        <div>
          <h2 class="text-xl sm:text-2xl font-semibold mb-1 text-gray-100">
            <%= @feature_request.title %>
          </h2>
          <p class="text-sm text-gray-400">
            Demande d'amélioration sponsorisée en sats ⚡
          </p>
        </div>

        <div class="text-sm text-gray-400">
          <p class="uppercase text-xs tracking-wide mb-1">Créée le</p>
          <p class="text-gray-100 font-semibold">
            <%= l(@feature_request.created_at, format: :short) rescue @feature_request.created_at %>
          </p>
        </div>
      </div>

      <!-- Description -->
      <div class="mt-4">
        <h3 class="text-sm font-semibold text-gray-300 uppercase tracking-wide mb-2">
          Description
        </h3>
        <div class="bg-gray-900/70 border border-gray-700 rounded-xl p-4">
          <p class="text-sm sm:text-base text-gray-200 leading-relaxed whitespace-pre-line">
            <%= @feature_request.description %>
          </p>
        </div>
      </div>

      <!-- Grid infos -->
      <div class="mt-6 grid gap-6 sm:grid-cols-3">

        <!-- Montant demandé -->
        <div class="bg-gray-900/70 border border-emerald-500/60 rounded-xl p-4">
          <h3 class="text-xs font-semibold text-gray-300 uppercase tracking-wide mb-1">
            Montant demandé
          </h3>
          <p class="text-2xl font-semibold text-emerald-300">
            <%= number_with_delimiter(@feature_request.amount_sats.to_i, delimiter: " ") %>
            <span class="text-xs text-emerald-200 ml-1">sats</span>
          </p>
          <p class="mt-2 text-xs text-gray-400">
            Montant total attendu pour que cette évolution soit financée.
          </p>
        </div>

        <!-- Statut -->
        <div class="bg-gray-900/70 border border-gray-700 rounded-xl p-4">
          <h3 class="text-xs font-semibold text-gray-300 uppercase tracking-wide mb-1">
            Statut
          </h3>
          <div class="mt-1">
            <%= feature_request_status_badge(@feature_request) %>
          </div>
          <p class="mt-2 text-xs text-gray-400">
            Indique où en est la demande : en attente, en paiement, payée ou livrée.
          </p>
        </div>

        <!-- Demandeur -->
        <div class="bg-gray-900/70 border border-gray-700 rounded-xl p-4">
          <h3 class="text-xs font-semibold text-gray-300 uppercase tracking-wide mb-1">
            Demandeur
          </h3>

          <% if @feature_request.email.present? %>
            <p class="text-sm text-gray-100 break-all">
              <%= @feature_request.email %>
            </p>
          <% else %>
            <p class="text-sm text-gray-500 italic">
              Non renseigné
            </p>
          <% end %>

          <p class="mt-2 text-xs text-gray-400">
            Utilisé uniquement pour échanger au sujet de cette demande si besoin.
          </p>
        </div>

      </div>
    </section>

    <!-- SPONSORING LIGHTNING -->
    <section class="mt-6 bg-gray-800/80 border border-gray-700 rounded-2xl p-6 sm:p-8 shadow-xl">
      <h2 class="text-xl sm:text-2xl font-semibold mb-2 text-gray-100">
        ⚡ Sponsoring Lightning
      </h2>
      <p class="text-sm text-gray-300 mb-4">
        Utilise notre serveur <strong>BTCPay</strong> pour générer une facture Lightning et sponsoriser cette
        amélioration de Bitcoin Monitor.
      </p>

      <% if @feature_request.status == "pending" && @feature_request.amount_sats.to_i > 0 %>

        <p class="text-sm text-gray-300 mb-4">
          Cette demande est prête à être sponsorisée. Clique sur le bouton ci-dessous pour générer une facture Lightning.
        </p>

        <%= button_to "Générer la facture Lightning",
                      generate_invoice_feature_request_path(@feature_request),
                      method: :post,
                      class: "w-full inline-flex items-center justify-center px-4 py-2 rounded-lg bg-amber-400 text-black text-sm font-semibold hover:bg-amber-300 transition shadow" %>

      <% elsif @feature_request.status == "awaiting_payment" %>

        <p class="text-sm text-gray-300 mb-4">
          La facture Lightning a été générée. Tu peux la régler via le checkout BTCPay.
        </p>

        <% if @feature_request.btcpay_checkout_url.present? %>
          <a href="<%= @feature_request.btcpay_checkout_url %>"
             target="_blank" rel="noopener"
             class="w-full inline-flex items-center justify-center px-4 py-2 rounded-lg bg-emerald-500 text-black text-sm font-semibold hover:bg-emerald-400 transition shadow">
            ⚡ Payer en Lightning
          </a>
        <% else %>
          <p class="text-sm text-red-400">
            ❌ Lien BTCPay introuvable. Vérifie la configuration du serveur.
          </p>
        <% end %>

      <% elsif %w[paid in_progress done].include?(@feature_request.status) %>

        <div class="mt-2 bg-gray-900/70 border border-emerald-500/70 rounded-xl p-4">
          <p class="text-sm font-semibold text-emerald-300">
            ✅ Facture payée — merci pour votre soutien !
          </p>
          <p class="mt-1 text-xs text-gray-300">
            La demande est en cours de traitement ou déjà livrée selon le statut courant.
          </p>
        </div>

      <% else %>

        <p class="text-sm text-gray-400">
          Cette demande n’est pas éligible au sponsoring Lightning pour le moment.
        </p>

      <% end %>
    </section>

    <!-- ACTIONS BAS DE PAGE -->
    <section class="mt-6 bg-gray-800/60 border border-gray-700 rounded-2xl p-4 sm:p-5 shadow-xl">
      <div class="flex flex-wrap items-center gap-4">
        <%= link_to "← Retour à la liste",
                    feature_requests_path,
                    class: "text-sm text-gray-300 hover:text-gray-100 hover:underline" %>

        <span class="h-4 w-px bg-gray-700"></span>

        <%= link_to "Modifier",
                    edit_feature_request_path(@feature_request),
                    class: "text-sm text-amber-300 hover:text-amber-200 hover:underline" %>

        <%= button_to "Supprimer",
                      @feature_request,
                      method: :delete,
                      data: { confirm: "Supprimer cette demande ?" },
                      class: "text-sm text-red-400 hover:text-red-300 hover:underline",
                      form: { class: "inline" } %>
      </div>
    </section>

  </div>
</div>
