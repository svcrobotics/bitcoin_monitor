<%# locals: trader_alerts:, range:, alerts_mode:, perf_pct:, pos_pct:, vol_pct:, max_drawdown_pct:, alignment: %>

<section class="mt-4 bg-gray-800/80 border border-gray-700 rounded-2xl p-4 sm:p-5 shadow-xl">
  <div class="flex items-start justify-between gap-3">
    <div>
      <h2 class="text-lg font-semibold text-gray-100">Alertes trader</h2>
      <p class="text-sm text-gray-400">SynthÃ¨se automatique basÃ©e sur prix + flux.</p>
    </div>
  </div>

  <div class="mt-3 flex flex-wrap gap-2">
    <% { "normal" => "Normal", "strict" => "Strict" }.each do |m, label| %>
      <% active = (alerts_mode == m) %>
      <%= link_to label,
                  market_price_path(range: range, alerts_mode: m),
                  class: "px-3 py-1.5 rounded-xl border text-sm transition " +
                         (active ? "bg-cyan-500/15 border-cyan-500/50 text-cyan-200"
                                 : "bg-gray-900/60 border-gray-700 text-gray-300 hover:bg-gray-800") %>
    <% end %>
  </div>

  <% if trader_alerts.present? %>
    <div class="mt-3 space-y-3">
      <% trader_alerts.each do |a| %>
        <div class="bg-gray-900/60 border border-gray-700 rounded-xl p-4">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-sm font-semibold text-gray-100"><%= a.title %></h3>
            <span class="text-[11px] px-2 py-0.5 rounded-full border <%= level_badge_classes(a.level) %>">
              <%= a.level.to_s.upcase %>
            </span>
          </div>

          <p class="text-sm text-gray-200 mt-1"><%= a.message %></p>

          <% if a.hint.present? %>
            <p class="text-xs text-gray-400 mt-2">
              <span class="font-semibold">Suggestion :</span> <%= a.hint %>
            </p>
          <% end %>

          <div class="mt-3">
            <%= link_to journal_entry_prefill_path(
                  mood: mood_from_level(a.level),
                  tags: "price,flow,alert,#{range},#{alerts_mode}",
                  context: "Alerte trader #{range} (#{alerts_mode}) â€” #{a.title}",
                  body: <<~TXT
                    Message:
                    #{a.message}

                    Suggestion:
                    #{a.hint}

                    Contexte:
                    Perf=#{perf_pct}% â€¢ Pos=#{pos_pct}% â€¢ Volâ‰ˆ#{vol_pct}%/j â€¢ DD=#{max_drawdown_pct}% â€¢ NetFlow=#{alignment&.flow_net_btc}

                    DÃ©cision:

                    Risque / invalidation:
                  TXT
                ),
                class: "inline-flex items-center gap-2 rounded-xl px-3 py-1.5 text-xs bg-gray-950/40 border border-gray-700 text-gray-200 hover:bg-gray-800 hover:border-gray-600 transition" do %>
              ğŸ“ Journaliser
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="mt-3 bg-gray-900/60 border border-gray-700 rounded-xl p-4">
      <p class="text-sm text-gray-300">
        Aucune alerte (mode <span class="font-mono"><%= alerts_mode %></span>).
      </p>
      <p class="text-xs text-gray-500 mt-1">
        Rien de â€œvraimentâ€ remarquable selon tes seuils actuels.
      </p>
    </div>
  <% end %>
</section>
