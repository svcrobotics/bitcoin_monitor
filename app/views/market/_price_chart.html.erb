<%# locals: price_series: (Hash "YYYY-MM-DD" => Float) %>

<% points = (price_series || {}).map { |d, v| [d, v.to_f] } %>

<div class="mt-4 rounded-2xl border border-gray-800 bg-black/20 p-3">
  <div class="relative" style="height: 320px;">
    <canvas id="btcPriceChart"></canvas>
  </div>
</div>

<script>
  (function () {
    const raw = <%= raw(points.to_json) %>;

    if (!raw || raw.length === 0) return;
    if (!window.Chart) { console.error("Chart.js not loaded"); return; }

    const labels = raw.map(r => r[0]);
    const data   = raw.map(r => Number(r[1]));

    const el = document.getElementById("btcPriceChart");
    if (!el) return;

    // Si turbo revisite la page, on d√©truit l'ancien chart
    if (el._chart) { el._chart.destroy(); el._chart = null; }

    el._chart = new Chart(el.getContext("2d"), {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "BTC (USD)",
          data
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: { legend: { display: true } },
        scales: {
          x: { ticks: { maxRotation: 0 } },
          y: { title: { display: true, text: "USD" } }
        }
      }
    });
  })();
</script>
