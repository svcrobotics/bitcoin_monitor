<%# app/views/dashboard/_daily_read.html.erb %>

<% flow    = ExchangeTrueFlow.recent.first %>
<% support = @price_zones && @price_zones[:support] %>
<% resist  = @price_zones && @price_zones[:resistance] %>

<% price_ref  = @price_now.presence || @price_live.presence %> <%# fallback %>
<% price_live = @price_live.presence %>

<%# ---------- Helpers simples ---------- %>
<% def zone_mid(z)
     return nil if z.blank?
     (z.low_usd.to_d + z.high_usd.to_d) / 2
   end
%>

<% def pct_dist(from, to)
     return nil if from.blank? || to.blank? || from.to_d <= 0
     ((to.to_d - from.to_d) / from.to_d * 100).round(2)
   end
%>

<%# ---------- Etat zones ---------- %>
<% s_mid = zone_mid(support) %>
<% r_mid = zone_mid(resist) %>

<% dist_to_support = (price_ref && s_mid) ? pct_dist(price_ref, s_mid) : nil %> <%# nÃ©gatif en gÃ©nÃ©ral %>
<% dist_to_resist  = (price_ref && r_mid) ? pct_dist(price_ref, r_mid) : nil %> <%# positif en gÃ©nÃ©ral %>

<% near_threshold = 1.2 %> <%# % : "proche" d'une zone (tweak) %>

<% in_support_zone =
     support.present? && price_ref.present? &&
     price_ref.to_d >= support.low_usd.to_d && price_ref.to_d <= support.high_usd.to_d
%>

<% in_resist_zone =
     resist.present? && price_ref.present? &&
     price_ref.to_d >= resist.low_usd.to_d && price_ref.to_d <= resist.high_usd.to_d
%>

<% near_support =
     dist_to_support.present? && dist_to_support.abs <= near_threshold
%>

<% near_resist =
     dist_to_resist.present? && dist_to_resist.abs <= near_threshold
%>

<% zone_label =
     if in_support_zone
       "ğŸŸ¢ Dans la zone de support"
     elsif in_resist_zone
       "ğŸ”´ Dans la zone de rÃ©sistance"
     elsif near_support
       "ğŸŸ¢ Proche du support"
     elsif near_resist
       "ğŸ”´ Proche de la rÃ©sistance"
     else
       "âšª Entre les zones"
     end
%>

<%# ---------- Etat flow ---------- %>
<% flow_label, flow_classes =
     case flow&.status
     when "red"   then ["ğŸ”´ ExcÃ¨s (dÃ©pÃ´ts Ã©levÃ©s)",   "text-rose-300 bg-rose-500/10 border-rose-700/50"]
     when "amber" then ["ğŸŸ¡ Tension (au-dessus de la moyenne)", "text-amber-300 bg-amber-500/10 border-amber-700/50"]
     when "green" then ["ğŸŸ¢ Normal (dans la norme)",  "text-emerald-300 bg-emerald-500/10 border-emerald-700/50"]
     else              ["â€”", "text-gray-300 bg-white/5 border-gray-700"]
     end
%>

<% ratio_txt   = flow&.ratio30.present? ? number_with_precision(flow.ratio30, precision: 2) : "â€”" %>
<% inflow_txt  = flow ? number_with_precision(flow.inflow_btc, precision: 2) : "â€”" %>
<% outflow_txt = flow ? number_with_precision(flow.outflow_btc, precision: 2) : "â€”" %>
<% netflow_txt = flow ? number_with_precision(flow.netflow_btc, precision: 2) : "â€”" %>

<% net_dir =
     if flow&.netflow_btc.to_d > 0 then "Les exchanges reÃ§oivent net"
     elsif flow&.netflow_btc.to_d < 0 then "Les exchanges distribuent net"
     else "Ã‰quilibre"
     end
%>

<%# ---------- DÃ©cision process (non-financier, juste un cadre) ---------- %>
<% decision_title = "Plan (process)" %>
<% decision_lines = [] %>

<% if flow.present? && price_ref.present? %>
  <% if flow.status == "red" && (in_resist_zone || near_resist) %>
    <% decision_lines << "Contexte fragile sous rÃ©sistance : privilÃ©gier lâ€™attente / confirmation." %>
    <% decision_lines << "ScÃ©nario A : rejet de la zone â†’ prudence (pas dâ€™ajout impulsif)." %>
    <% decision_lines << "ScÃ©nario B : cassure + maintien au-dessus â†’ absorption possible (attendre confirmation)." %>
  <% elsif flow.status == "red" && (in_support_zone || near_support) %>
    <% decision_lines << "Support + dÃ©pÃ´ts Ã©levÃ©s : risque de cassure si le support cÃ¨de." %>
    <% decision_lines << "ScÃ©nario A : le support tient â†’ rebond possible mais volatil." %>
    <% decision_lines << "ScÃ©nario B : cassure nette â†’ prochaine zone (bonus/support plus bas) Ã  surveiller." %>
  <% elsif flow.status == "green" && (in_support_zone || near_support) %>
    <% decision_lines << "Support + flow normal : contexte plus â€œstableâ€ (moins de pression vendeuse visible)." %>
    <% decision_lines << "Regarder rÃ©action prix : wick/rebond vs clÃ´ture sous zone." %>
  <% elsif flow.status == "green" && (in_resist_zone || near_resist) %>
    <% decision_lines << "RÃ©sistance + flow normal : test â€œpropreâ€ possible." %>
    <% decision_lines << "Attendre validation (break/hold) plutÃ´t que deviner." %>
  <% else %>
    <% decision_lines << "Prix entre zones : Ã©viter de sur-interprÃ©ter le flow isolÃ©." %>
    <% decision_lines << "Attendre un test clair dâ€™une zone (support ou rÃ©sistance)." %>
  <% end %>
<% else %>
  <% decision_lines << "DonnÃ©es insuffisantes (prix/zones/flow). RafraÃ®chir le snapshot et recalculer si besoin." %>
<% end %>

<%# ---------- Journaliser la lecture complÃ¨te ---------- %>
<% mood =
     case flow&.status
     when "red" then "red"
     when "amber" then "amber"
     else "green"
     end
%>

<% zone_ctx =
     if support.present? && resist.present? && price_ref.present?
       "Zone: #{zone_label} â€¢ dist_support #{dist_to_support || "â€”"}% â€¢ dist_resist #{dist_to_resist || "â€”"}%"
     else
       "Zone: #{zone_label}"
     end
%>

<% flow_ctx = flow.present? ? "TrueFlow 24h: inflow #{inflow_txt} BTC â€¢ outflow #{outflow_txt} BTC â€¢ net #{netflow_txt} BTC â€¢ ratio30 x#{ratio_txt} (#{flow.status})" : "TrueFlow: â€”" %>

<% ctx  = "#{zone_ctx} â€¢ #{flow_ctx}" %>
<% tags = "lecture,price_zones,trueflow,decision" %>
<% body = "Observation:\n#{ctx}\n\nHypothÃ¨se:\n\nDÃ©cision:\n\nRisque / invalidation:\n" %>

<section class="mt-6 bg-gray-800/80 border border-gray-700 rounded-2xl p-6 sm:p-8 shadow-xl">
  <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
    <div class="min-w-0">
      <h2 class="text-xl sm:text-2xl font-semibold mb-1">Lecture du jour (Zones + Flow)</h2>
      <p class="text-sm text-gray-400">
        Pont â€œoÃ¹ est le prix ?â€ + â€œpression (flow)â€ â†’ plan de lecture.
        <span class="text-gray-500">Pas un conseil financier.</span>
      </p>
    </div>

    <div class="flex items-center gap-2">
      <span class="text-xs px-3 py-1 rounded-full border <%= flow_classes %>"><%= flow_label %></span>

      <%= link_to new_journal_entry_path(
            occurred_at: Time.current.strftime("%Y-%m-%dT%H:%M"),
            kind: "observation",
            mood: mood,
            context: ctx,
            tags: tags,
            body: body
          ),
          class: "inline-flex items-center gap-2 rounded-xl px-3 py-1.5 text-xs
                  bg-gray-900/70 border border-gray-700 text-gray-200
                  hover:bg-gray-800 hover:border-gray-600 transition" do %>
        ğŸ“ Journaliser la lecture
      <% end %>
    </div>
  </div>

  <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
    <div class="bg-black/30 border border-gray-700 rounded-xl p-4">
      <div class="text-xs text-gray-400">Position (rÃ©fÃ©rence)</div>
      <div class="mt-1 text-sm font-semibold text-gray-100"><%= zone_label %></div>
      <div class="mt-2 text-[11px] text-gray-500">
        Prix ref :
        <span class="font-mono"><%= price_ref.present? ? number_to_currency(price_ref.to_f, unit: "$", precision: 0, delimiter: " ") : "â€”" %></span>
        <% if price_live.present? %>
          <span class="text-gray-600">â€¢ live</span>
          <span class="font-mono"><%= number_to_currency(price_live.to_f, unit: "$", precision: 0, delimiter: " ") %></span>
        <% end %>
      </div>
      <div class="mt-2 text-[11px] text-gray-500">
        dist support: <span class="font-mono"><%= dist_to_support.present? ? "#{dist_to_support}%" : "â€”" %></span>
        â€¢ dist resist: <span class="font-mono"><%= dist_to_resist.present? ? "#{dist_to_resist}%" : "â€”" %></span>
      </div>
    </div>

    <div class="bg-black/30 border border-gray-700 rounded-xl p-4">
      <div class="text-xs text-gray-400">Flow (24h)</div>
      <% if flow.present? %>
        <div class="mt-1 text-sm font-semibold text-gray-100">
          Inflow <span class="font-mono"><%= inflow_txt %></span> â€¢ Outflow <span class="font-mono"><%= outflow_txt %></span>
        </div>
        <div class="mt-2 text-[11px] text-gray-500">
          Netflow : <span class="font-mono"><%= netflow_txt %></span> BTC â€” <%= net_dir %>
        </div>
        <div class="mt-2 text-[11px] text-gray-500">
          Ratio vs 30j : <span class="font-mono">x <%= ratio_txt %></span>
        </div>
      <% else %>
        <div class="mt-1 text-sm text-gray-300">â€”</div>
      <% end %>
    </div>

    <div class="bg-black/30 border border-gray-700 rounded-xl p-4">
      <div class="text-xs text-gray-400"><%= decision_title %></div>
      <div class="mt-2 space-y-1">
        <% decision_lines.first(3).each do |line| %>
          <p class="text-sm text-gray-200">â€¢ <%= line %></p>
        <% end %>
      </div>
      <p class="mt-3 text-[11px] text-gray-500">
        Astuce : journalise surtout quand on est â€œproche zoneâ€ + (ğŸŸ¡/ğŸ”´) ou quand il y a cassure/rejet clair.
      </p>
    </div>
  </div>
</section>
