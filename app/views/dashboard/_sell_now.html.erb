<%# app/views/dashboard/_sell_now.html.erb %>
<% return unless @active_position.present? && @sell_now.present? %>

<section class="mt-6 bg-gray-800/80 border border-gray-700 rounded-2xl p-6 sm:p-8 shadow-xl">
  <div class="flex items-start justify-between gap-3">
    <div class="min-w-0">
      <h2 class="text-xl sm:text-2xl font-semibold mb-1">Si je vends aujourd’hui</h2>
      <p class="text-sm text-gray-400">
        Position : achat <span class="font-mono text-gray-200"><%= @active_position.buy_day %></span>
        · BTC <span class="font-mono text-gray-200"><%= @active_position.btc_amount %></span>
      </p>
    </div>

    <span class="text-xs px-2 py-1 rounded-full border border-gray-700 text-gray-300 bg-white/5">
      Jour <span class="font-mono"><%= @sell_now.as_of_day %></span>
    </span>
  </div>

  <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-3">
    <div class="rounded-xl border border-gray-700 bg-black/20 p-4">
      <p class="text-xs text-gray-500">Prix BTC (USD)</p>
      <p class="font-mono text-lg text-gray-100"><%= number_to_currency(@sell_now.price_now_usd, unit: "$") %></p>
    </div>

    <div class="rounded-xl border border-gray-700 bg-black/20 p-4">
      <p class="text-xs text-gray-500">Net si vente</p>
      <p class="font-mono text-lg text-gray-100"><%= number_to_currency(@sell_now.sell_net_usd, unit: "$") %></p>
    </div>

    <div class="rounded-xl border border-gray-700 bg-black/20 p-4">
      <p class="text-xs text-gray-500">PnL</p>
      <p class="font-mono text-lg <%= @sell_now.pnl_usd.to_f >= 0 ? "text-emerald-300" : "text-rose-300" %>">
        <%= number_to_currency(@sell_now.pnl_usd, unit: "$") %>
      </p>
      <p class="text-sm text-gray-400 mt-1">
        soit <span class="font-mono text-gray-200"><%= number_with_precision(@sell_now.pnl_pct, precision: 2) %>%</span>
      </p>
    </div>
  </div>

  <%# ============================
      # Score décisionnel (SELL/HOLD/NEUTRAL)
      # ============================ %>
  <% if @sell_score.present? %>
    <% s = @sell_score.is_a?(Hash) ? @sell_score.deep_symbolize_keys : {} %>

    <% action = s[:action].to_s %>
    <% score  = s[:score].to_i %>
    <% suggestion_label = s[:suggestion_label].to_s %>
    <% confidence = s[:confidence].to_s %>
    <% trailing = s[:trailing].is_a?(Hash) ? s[:trailing].deep_symbolize_keys : {} %>

    <% lv = s[:next_levels].is_a?(Hash) ? s[:next_levels].deep_symbolize_keys : {} %>

    <% badge =
      case action
      when "sell"    then "border-rose-500/50 text-rose-200 bg-rose-500/10"
      when "neutral" then "border-amber-500/50 text-amber-200 bg-amber-500/10"
      when "hold"    then "border-emerald-500/50 text-emerald-200 bg-emerald-500/10"
      else                "border-gray-700 text-gray-300 bg-white/5"
      end
    %>

    <div class="mt-5 rounded-2xl border border-gray-700 bg-gray-900/50 p-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div>
          <p class="text-sm text-gray-300">
            Vendre aujourd’hui ?
            <span class="inline-flex items-center gap-2 px-2 py-1 rounded-full border <%= badge %> ml-2">
              <span class="font-semibold"><%= action.upcase %></span>
              <span class="text-xs text-gray-300/80">score <span class="font-mono"><%= score %></span>/100</span>
            </span>
          </p>

          <% if suggestion_label.present? || confidence.present? %>
            <p class="text-xs text-gray-400 mt-1">
              <% if suggestion_label.present? %>
                Suggestion : <span class="text-gray-200 font-semibold"><%= suggestion_label %></span>
              <% end %>
              <% if confidence.present? %>
                <span class="text-gray-500 ml-2">• confiance <span class="font-mono"><%= confidence %></span></span>
              <% end %>
            </p>
          <% end %>

          <%# Chips niveaux clés %>
          <% if lv.present? %>
            <div class="mt-2 flex flex-wrap gap-2">
              <% if lv[:support_mid].present? %>
                <span class="text-xs px-2 py-1 rounded-full border border-emerald-500/30 bg-emerald-500/10 text-emerald-200">
                  Support ~ <span class="font-mono"><%= number_to_currency(lv[:support_mid], unit: "$", precision: 0) %></span>
                  <% if lv[:support_dist_pct].present? %>
                    <span class="text-emerald-100/80">
                      (<span class="font-mono"><%= number_with_precision(lv[:support_dist_pct].to_f, precision: 2) %>%</span>)
                    </span>
                  <% end %>
                </span>
              <% end %>

              <% if lv[:resistance_mid].present? %>
                <span class="text-xs px-2 py-1 rounded-full border border-rose-500/30 bg-rose-500/10 text-rose-200">
                  Résistance ~ <span class="font-mono"><%= number_to_currency(lv[:resistance_mid], unit: "$", precision: 0) %></span>
                  <% if lv[:resistance_dist_pct].present? %>
                    <span class="text-rose-100/80">
                      (<span class="font-mono"><%= number_with_precision(lv[:resistance_dist_pct].to_f, precision: 2) %>%</span>)
                    </span>
                  <% end %>
                </span>
              <% end %>
            </div>
          <% end %>
        </div>

        <% if trailing.present? %>
          <p class="text-xs text-gray-500">
            Pic: <span class="font-mono text-gray-300"><%= trailing[:peak_day] %></span>
            (<span class="font-mono text-emerald-300"><%= number_with_precision(trailing[:peak_pnl_pct].to_f, precision: 2) %>%</span>)
            • Repli:
            <span class="font-mono text-amber-300"><%= number_with_precision(trailing[:drawdown_from_peak_pct].to_f, precision: 2) %>%</span>
          </p>
        <% end %>
      </div>

      <% if s[:reasons].present? %>
        <ul class="mt-3 space-y-1">
          <% Array(s[:reasons]).first(6).each do |r| %>
            <% r = r.is_a?(Hash) ? r.deep_symbolize_keys : {} %>
            <li class="text-sm text-gray-300">
              • <span class="text-gray-200"><%= r[:label].to_s %></span>
              <% if r[:impact].to_i != 0 %>
                <span class="text-xs text-gray-500 ml-1">(impact <span class="font-mono"><%= r[:impact].to_i %></span>)</span>
              <% end %>
            </li>
          <% end %>
        </ul>
      <% end %>

      <%# Plan SELL %>
      <% if s[:plan].present? %>
        <div class="mt-3 rounded-xl border border-gray-800 bg-gray-900/40 p-3">
          <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Plan</p>
          <p class="text-sm text-gray-200"><%= s[:plan].to_s %></p>
        </div>
      <% end %>
    </div>
  <% end %>

  <div class="mt-4 flex flex-wrap gap-2">
    <%= link_to "Voir la position", @active_position,
      class: "rounded-xl px-4 py-2 bg-gray-900/60 border border-gray-700/60 text-gray-200 hover:bg-gray-800 hover:border-gray-600 transition text-sm font-semibold" %>

    <%= link_to "Créer une nouvelle position", new_trade_simulation_path,
      class: "rounded-xl px-4 py-2 bg-cyan-600/15 border border-cyan-500/50 text-cyan-200 hover:bg-cyan-600/25 hover:border-cyan-400 transition text-sm font-semibold" %>
  </div>
</section>
